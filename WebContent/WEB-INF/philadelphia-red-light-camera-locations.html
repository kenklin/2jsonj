<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Philadelphia, PA - Red Light Camera Locations</title>
<style>
html,body,#map-canvas {
	height: 100%;
	margin: 0px;
	padding: 0px
}

#panel {
	position: absolute;
	top: 5px;
	left: 50%;
	margin-left: -180px;
	z-index: 5;
	background-color: #fff;
	padding: 5px;
	border: 1px solid #999;
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
<script>
	// Adapted from https://developers.google.com/maps/documentation/javascript/examples/marker-animations-iteration?hl=fr-FR
	// If you're adding a number of markers, you may want to
	// drop them on the map consecutively rather than all at once.
	// This example shows how to use setTimeout() to space
	// your markers' animation.

	var center = new google.maps.LatLng(39.964491 + 0.05, -75.163651 + 0.05);

	var locations = [];
	var titles = [];

	var csvUrl = "https://raw.github.com/CityOfPhiladelphia/ppa-data/master/red-light-cameras/red-light-camera-locations.csv";
	var toJsonUrl = "http://localhost:8080/2jsonj/csv2json/api?url=";
	var mapsUrl = "http://maps.googleapis.com/maps/api/geocode/json?address=";

	function setStaticLocations() {
		locations.push(new google.maps.LatLng(40.080555, -75.02851799999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Grant%20Ave&sensor=false
		locations.push(new google.maps.LatLng(40.094426, -75.015081)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Red%20Lion%20Rd&sensor=false
		locations.push(new google.maps.LatLng(40.04613998029149, -75.05326401970851)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Cottman%20Ave&sensor=false
		locations.push(new google.maps.LatLng(39.916387, -75.171274)); // http://maps.googleapis.com/maps/api/geocode/json?address=Broad%20St%20@%20Oregon%20Ave%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(39.939546, -75.198323)); //http://maps.googleapis.com/maps/api/geocode/json?address=34th%20Street%20@%20Grays%20Ferry%20Ave%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.024982, -75.12562000000001)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Mascher%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.034919, -75.06964400000001)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Levick%20St%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.056351, -75.04627499999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Rhawn%20St%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.074032, -75.03477699999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Welsh%20Rd%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.11379, -74.98749800000002)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%20Southampton%20Rd%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.022358, -75.13949699999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Roosevelt%20Blvd%20@%209th%20St%20Philadelphia&sensor=false
		locations.push(new google.maps.LatLng(40.1379919, -74.9557629)); // http://maps.googleapis.com/maps/api/geocode/json?address=Broad%20St%20@%20Hunting%20Park%20AveOregon%20Ave,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(39.95847, -75.23733)); // http://maps.googleapis.com/maps/api/geocode/json?address=58th%20St%20@%20Walnut%20St,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(39.9523882, -75.1640233)); // http://maps.googleapis.com/maps/api/geocode/json?address=City%20Hall,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.039232, -75.11)); // http://maps.googleapis.com/maps/api/geocode/json?address=Rising%20Sun%20Ave%20@%20Adams%20Ave,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.0077858, -75.07306009999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Aramingo%20Ave%20@%20Castor%20Ave,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(39.9754, -75.120869)); // http://maps.googleapis.com/maps/api/geocode/json?address=Aramingo%20Ave%20@%20York%20St,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.028764, -75.20550600000001)); // http://maps.googleapis.com/maps/api/geocode/json?address=Henry%20Ave%20@%20Walnut%20Ln,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(39.957359, -75.16237199999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Broad%20St%20@%20Vine%20St,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(39.904247, -75.239965)); // http://maps.googleapis.com/maps/api/geocode/json?address=Island%20Ave%20@%20Lindbergh%20Blvd,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.069169, -75.007622)); // http://maps.googleapis.com/maps/api/geocode/json?address=Academy%20Rd%20@%20Grant%20Ave,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.1282105, -75.023183)); // http://maps.googleapis.com/maps/api/geocode/json?address=Bustleton%20Ave%20@%20Byberry%20Rd,%20Philadelphia,%20PA&sensor=false
		locations.push(new google.maps.LatLng(40.086689, -74.97175299999999)); // http://maps.googleapis.com/maps/api/geocode/json?address=Knights%20Rd%20@%20Woodhaven%20Rd,%20Philadelphia,%20PA&sensor=false    	
	}

	function pushLatLng(str) {
		str = encodeURI(str + ", Philadelphia, PA");
		var url = mapsUrl + str + "&sensor=false";
		$.getJSON(url, function(data) {
			locations.push(new google.maps.LatLng(
				data.results[0].geometry.location.lat,
				data.results[0].geometry.location.lng));
			titles.push(data.results[0].address_components[0].short_name);
		}).fail(function(jqXHR, textStatus, err) {
			alert("fail in map");
		});
	}

	function setLocations() {
		var url = toJsonUrl + csvUrl;
		$.getJSON(url, {format : 'json'}, function(data) {
			var lastIntersection = "";	// skip duplicate intersections
			data.data.items.forEach(function(item) {
				if (item.Intersection != lastIntersection) {
					lastIntersection = item.Intersection;
					pushLatLng(item.Intersection);
				}
			});
		}).fail(function(jqXHR, textStatus, err) {
			alert("Failure. Switching to static data.");
			setStaticLocations();
		});
	}

	var markers = [];
	var iterator = 0;

	var map;

	function initialize() {
		var mapOptions = {
			zoom : 12,
			mapTypeId : google.maps.MapTypeId.ROADMAP,
			center : center
		};

		map = new google.maps.Map(document.getElementById('map-canvas'),
				mapOptions);
		setLocations();
		
		// See https://developers.google.com/maps/tutorials/customizing/adding-a-legend	
		var legend = document.getElementById('legend');
		var div = document.createElement('div');
		div.innerHTML = 'Source: <a href="' + csvUrl + '">' + csvUrl + '</a>';
		legend.appendChild(div);
		map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);
	}

	function drop() {
		for ( var i = 0; i < locations.length; i++) {
			setTimeout(function() {
				addMarker();
			}, i * 200);
		}
	}

	function addMarker() {
		markers.push(new google.maps.Marker({
			position : locations[iterator],
			title : titles[iterator],
			map : map,
			draggable : false,
			animation : google.maps.Animation.DROP
		}));
		iterator++;
	}

	google.maps.event.addDomListener(window, 'load', initialize);	
</script>
</head>
<body>
	<div id="panel" style="margin-left: -52px">
		<button id="drop" onclick="drop()">Philadelphia, PA - Red
			Light Camera Locations</button>
	</div>
	<div id="map-canvas"></div>
	<div id="legend"></div>
</body>
</html>